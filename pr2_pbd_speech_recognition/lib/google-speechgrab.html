<script>
console.log('test');
var fileWriter;

var QueryString = function () {
  // This function is anonymous, is executed immediately and 
  // the return value is assigned to QueryString!
  var query_string = {};
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
    	// If first entry with this name
    if (typeof query_string[pair[0]] === "undefined") {
      query_string[pair[0]] = pair[1];
    	// If second entry with this name
    } else if (typeof query_string[pair[0]] === "string") {
      var arr = [ query_string[pair[0]], pair[1] ];
      query_string[pair[0]] = arr;
    	// If third or later entry with this name
    } else {
      query_string[pair[0]].push(pair[1]);
    }
  } 
    return query_string;
} ();

function errorHandler(e) {
  var msg = '';

  switch (e.code) {
    case FileError.QUOTA_EXCEEDED_ERR:
      msg = 'QUOTA_EXCEEDED_ERR';
      break;
    case FileError.NOT_FOUND_ERR:
      msg = 'NOT_FOUND_ERR';
      break;
    case FileError.SECURITY_ERR:
      msg = 'SECURITY_ERR';
      break;
    case FileError.INVALID_MODIFICATION_ERR:
      msg = 'INVALID_MODIFICATION_ERR';
      break;
    case FileError.INVALID_STATE_ERR:
      msg = 'INVALID_STATE_ERR';
      break;
    default:
      msg = 'Unknown Error';
      break;
  };

  console.log('Error: ' + msg);
}

onWriterCreated = function(writer) {
    fileWriter = writer;
    writer.truncate(0);
}

onFileCreation = function(fileEntry) {
    console.log('Created file');
    fileEntry.createWriter(onWriterCreated, errorHandler);
}

initFS = function(fs) {
    console.log('Opened file system: ' + fs.name);
    fs.root.getFile('transcription.txt', {create: true}, onFileCreation);
}

window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
window.requestFileSystem(window.TEMPORARY, 1024*1024, initFS, errorHandler);

var recognition = new webkitSpeechRecognition();
recognition.continuous = true;
recognition.interimResults = true;

recognition.onstart = function() {
    recognizing = true;
};

recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
        console.log('no-speech');
    }
    if (event.error == 'audio-capture') {
        console.log('audio-capture');
    }
    if (event.error == 'not-allowed') {
        console.log('not-allowed');
    }
};

recognition.onend = function () {
    console.log('no more recognition');
    recognizing = false;
    recognition.start();
};

recognition.onresult = function(event) {
    var interim_transcript = '';
    var final_transcript = '';
    if (typeof(event.results) == 'undefined') {
        recognition.onend = null;
        recognition.stop();
        return;
    }
    for (var i = event.resultIndex; i < event.results.length; ++i) {
        if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
            console.log('Final: ' + final_transcript);
            fileWriter.write(new Blob([final_transcript + '\n'], {type: 'text/plain'}));
            recognition.stop();
            document.getElementById('speech').innerHTML = final_transcript;
 
        } else {
            interim_transcript += event.results[i][0].transcript;
            document.getElementById('speech').innerHTML = interim_transcript;
            console.log('Interim: ' + interim_transcript);
        }
    }
};

recognition.lang = QueryString.lang || 'en-US';
recognition.start();
</script>
<h1 id="speech" style='font-family: "Open Sans",Helvetica,Arial,sans-serif;'>Ready for speech...</div>
