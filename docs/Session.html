<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Session.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>Session.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="sd">&#39;&#39;&#39;Everything related to an experiment session&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">ProgrammedAction</span> <span class="kn">import</span> <span class="n">ProgrammedAction</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">from</span> <span class="nn">pr2_pbd_interaction.msg</span> <span class="kn">import</span> <span class="n">ExperimentState</span>
<span class="kn">from</span> <span class="nn">pr2_pbd_interaction.srv</span> <span class="kn">import</span> <span class="n">GetExperimentState</span>
<span class="kn">from</span> <span class="nn">pr2_pbd_interaction.srv</span> <span class="kn">import</span> <span class="n">GetExperimentStateResponse</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Session</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39;This class holds and maintains experimental data&#39;&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">,</span> <span class="n">is_debug</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_reload</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;/pr2_pbd_interaction/isReload&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span> <span class="o">=</span> <span class="n">object_list</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">is_debug</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span>
                                <span class="s">&#39;/pr2_pbd_interaction/experimentNumber&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_get_participant_id</span><span class="p">()</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="s">&#39;data_directory&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_reload</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_session_state</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">&quot;Session state loaded.&quot;</span><span class="p">)</span>

        <span class="n">n_actions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">n_actions</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">n_frames</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state_publisher</span> <span class="o">=</span> <span class="n">rospy</span><span class="o">.</span><span class="n">Publisher</span><span class="p">(</span><span class="s">&#39;experiment_state&#39;</span><span class="p">,</span>
                                                <span class="n">ExperimentState</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">Service</span><span class="p">(</span><span class="s">&#39;get_experiment_state&#39;</span><span class="p">,</span> <span class="n">GetExperimentState</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">get_experiment_state_cb</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_selected_step_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_step</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates the selected step when interactive</span>
<span class="sd">        markers are clicked on&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step</span> <span class="o">=</span> <span class="n">selected_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_experiment_state_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Response to the experiment state service call&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">GetExperimentStateResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_experiment_state</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_update_experiment_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Publishes a message with the latest state&#39;&#39;&#39;</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_experiment_state</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_publisher</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">state</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_experiment_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Creates a message with the latest state&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">ExperimentState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_states</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_gripper_states</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_frames</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_frames</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_ref_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the reference frames for the steps of the</span>
<span class="sd">        current action in array format&#39;&#39;&#39;</span>
        <span class="n">ref_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">()):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span>
            <span class="n">ref_frame</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get_step_ref_frame</span><span class="p">(</span><span class="n">arm_index</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">ref_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref_frame</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ref_frames</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_gripper_states</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arm_index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Returns the gripper states for current action</span>
<span class="sd">        in array format&#39;&#39;&#39;</span>
        <span class="n">gripper_states</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">()):</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span>
            <span class="n">gripper_state</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">get_step_gripper_state</span><span class="p">(</span><span class="n">arm_index</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">gripper_states</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gripper_state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gripper_states</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">select_action_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Makes the interactive marker for the indicated action</span>
<span class="sd">        step selected, by showing the 6D controls&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">select_step</span><span class="p">(</span><span class="n">step_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step</span> <span class="o">=</span> <span class="n">step_id</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_participant_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Gets the experiment number from the command line&#39;&#39;&#39;</span>
        <span class="k">while</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">raw_input</span><span class="p">(</span>
                                    <span class="s">&#39;Please enter participant ID:&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&quot;Participant ID needs to be a number&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">_get_data_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;A directory for this participant &#39;</span> <span class="o">+</span>
                              <span class="s">&#39;ID already exists: &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>
                <span class="n">overwrite</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&#39;Do you want to overwrite? &#39;</span> <span class="o">+</span>
                                      <span class="s">&#39;Type r to reload the last state &#39;</span> <span class="o">+</span>
                                      <span class="s">&#39;of the experiment. [y/n/r]&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">overwrite</span> <span class="o">==</span> <span class="s">&#39;y&#39;</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">overwrite</span> <span class="o">==</span> <span class="s">&#39;n&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exp_number</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">overwrite</span> <span class="o">==</span> <span class="s">&#39;r&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_is_reload</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&#39;Invalid response, try again.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_data_dir</span><span class="p">(</span><span class="n">exp_number</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the directory where action information is saved&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">rospy</span><span class="o">.</span><span class="n">get_param</span><span class="p">(</span><span class="s">&#39;/pr2_pbd_interaction/dataRoot&#39;</span><span class="p">)</span> <span class="o">+</span>
                    <span class="s">&#39;/data/experiment&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exp_number</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_session_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_save_actions</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Saves the session state onto hard drive&#39;&#39;&#39;</span>
        <span class="n">exp_state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">exp_state</span><span class="p">[</span><span class="s">&#39;nProgrammedActions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span>
        <span class="n">exp_state</span><span class="p">[</span><span class="s">&#39;currentProgrammedActionIndex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span>
        <span class="n">state_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">+</span> <span class="s">&#39;experimentState.yaml&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">state_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">exp_state</span><span class="p">))</span>
        <span class="n">state_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">is_save_actions</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_load_session_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Loads the experiment state from the hard drive&#39;&#39;&#39;</span>
        <span class="n">state_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span> <span class="o">+</span> <span class="s">&#39;experimentState.yaml&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">exp_state</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">state_file</span><span class="p">)</span>
        <span class="n">n_actions</span> <span class="o">=</span> <span class="n">exp_state</span><span class="p">[</span><span class="s">&#39;nProgrammedActions&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_actions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">update</span><span class="p">({(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> <span class="n">ProgrammedAction</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step_cb</span><span class="p">)})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">=</span> <span class="n">exp_state</span><span class="p">[</span><span class="s">&#39;currentProgrammedActionIndex&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">initialize_viz</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span>
        <span class="n">state_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">new_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates new action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">reset_viz</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">:</span>
                             <span class="n">ProgrammedAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_selected_step_cb</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">n_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the number of actions programmed so far&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_current_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the current action&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <pre><code>def get_current_action_name(self):
    return self.actions[self.current_action_index].get_name()
</code></pre>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">clear_current_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes all steps in the current action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">undo_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Undo the effect of clear&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">undoClear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">save_current_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Save current action onto hard drive&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data_dir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_session_state</span><span class="p">(</span><span class="n">is_save_actions</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">add_step_to_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Add a new step to the current action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">add_action_step</span><span class="p">(</span><span class="n">step</span><span class="p">,</span>
                                                                <span class="n">object_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span> <span class="o">=</span> <span class="n">object_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delete_last_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes the last step of the action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">delete_last_step</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">resume_deleted_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Resumes the deleted step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">resume_deleted_step</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">switch_to_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_number</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Switches to indicated action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">action_number</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="ow">and</span> <span class="n">action_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">reset_viz</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">=</span> <span class="n">action_number</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">initialize_viz</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;Cannot switch to action &#39;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">action_number</span><span class="p">))</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span> <span class="o">=</span> <span class="n">object_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">success</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">next_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Switches to next action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">reset_viz</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">initialize_viz</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span> <span class="o">=</span> <span class="n">object_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">success</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">previous_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">object_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Switches to previous action&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">reset_viz</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_current_action</span><span class="p">()</span><span class="o">.</span><span class="n">initialize_viz</span><span class="p">(</span><span class="n">object_list</span><span class="p">)</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
            <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_object_list</span> <span class="o">=</span> <span class="n">object_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_experiment_state</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">success</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">n_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the number of frames&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_actions</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">actions</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">current_action_index</span><span class="p">]</span><span class="o">.</span><span class="n">n_frames</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;No skills created yet.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
