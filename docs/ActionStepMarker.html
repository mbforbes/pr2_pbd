<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>ActionStepMarker.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id="background"></div>
<div id='container'>
  <div class='section'>
    <div class='docs'><h1>ActionStepMarker.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="sd">&#39;&#39;&#39;Stuff related to a single marker for steps of an action&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">roslib</span>
<span class="n">roslib</span><span class="o">.</span><span class="n">load_manifest</span><span class="p">(</span><span class="s">&#39;pr2_pbd_interaction&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">rospy</span>
<span class="kn">import</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">pr2_pbd_interaction.msg</span> <span class="kn">import</span> <span class="n">ActionStep</span><span class="p">,</span> <span class="n">ArmState</span><span class="p">,</span> <span class="n">Object</span><span class="p">,</span> <span class="n">GripperState</span>
<span class="kn">from</span> <span class="nn">geometry_msgs.msg</span> <span class="kn">import</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Vector3</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Pose</span>
<span class="kn">from</span> <span class="nn">std_msgs.msg</span> <span class="kn">import</span> <span class="n">Header</span><span class="p">,</span> <span class="n">ColorRGBA</span>
<span class="kn">from</span> <span class="nn">visualization_msgs.msg</span> <span class="kn">import</span> <span class="n">Marker</span><span class="p">,</span> <span class="n">InteractiveMarker</span>
<span class="kn">from</span> <span class="nn">visualization_msgs.msg</span> <span class="kn">import</span> <span class="n">InteractiveMarkerControl</span>
<span class="kn">from</span> <span class="nn">visualization_msgs.msg</span> <span class="kn">import</span> <span class="n">InteractiveMarkerFeedback</span>
<span class="kn">from</span> <span class="nn">interactive_markers.interactive_marker_server</span> <span class="kn">import</span> <span class="n">InteractiveMarkerServer</span>
<span class="kn">from</span> <span class="nn">interactive_markers.menu_handler</span> <span class="kn">import</span> <span class="n">MenuHandler</span>
<span class="kn">from</span> <span class="nn">Arms</span> <span class="kn">import</span> <span class="n">Arms</span>
<span class="kn">from</span> <span class="nn">World</span> <span class="kn">import</span> <span class="n">World</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">ActionStepMarker</span><span class="p">:</span>
    <span class="sd">&#39;&#39;&#39; Marker for visualizing the steps of an action&#39;&#39;&#39;</span>

    <span class="n">_im_server</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_offset</span> <span class="o">=</span> <span class="mf">0.09</span>
    <span class="n">_ref_object_list</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_ref_names</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">_marker_click_cb</span> <span class="o">=</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step_number</span><span class="p">,</span> <span class="n">arm_index</span><span class="p">,</span> <span class="n">action_step</span><span class="p">,</span>
                 <span class="n">marker_click_cb</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">im_server</span> <span class="o">=</span> <span class="n">InteractiveMarkerServer</span><span class="p">(</span><span class="s">&#39;programmed_actions&#39;</span><span class="p">)</span>
            <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span> <span class="o">=</span> <span class="n">im_server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span> <span class="o">=</span> <span class="n">action_step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">=</span> <span class="n">arm_index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_number</span> <span class="o">=</span> <span class="n">step_number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_requested</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_deleted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_edited</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_object</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_marker_click_cb</span> <span class="o">=</span> <span class="n">marker_click_cb</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_is_reachable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Checks if there is an IK solution for action step&#39;&#39;&#39;</span>
        <span class="n">dummy</span><span class="p">,</span> <span class="n">is_reachable</span> <span class="o">=</span> <span class="n">Arms</span><span class="o">.</span><span class="n">solve_ik_for_arm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">get_target</span><span class="p">())</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">&#39;Reachability of pose in ActionStepMarker : &#39;</span> <span class="o">+</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">is_reachable</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">is_reachable</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a unique id of the marker&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">step_number</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Generates the unique name for the marker&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&#39;step&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_number</span><span class="p">)</span>
                                        <span class="o">+</span> <span class="s">&#39;arm&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">decrease_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Reduces the index of the marker&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">step_number</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_menu</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_ref_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_frame_list</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates and re-assigns coordinate frames when the world changes&#39;&#39;&#39;</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>There is a new list of objects
If the current frames are already assigned to object,
we need to figure out the correspondences</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_object_list</span> <span class="o">=</span> <span class="n">ref_frame_list</span>

        <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">arm_pose</span><span class="o">.</span><span class="n">refFrame</span> <span class="o">==</span> <span class="n">ArmState</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">):</span>
            <span class="n">prev_ref_obj</span> <span class="o">=</span> <span class="n">arm_pose</span><span class="o">.</span><span class="n">refFrameObject</span>
            <span class="n">new_ref_obj</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_most_similar_obj</span><span class="p">(</span><span class="n">prev_ref_obj</span><span class="p">,</span>
                                                    <span class="n">ref_frame_list</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_object</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">new_ref_obj</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_object</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">arm_pose</span><span class="o">.</span><span class="n">refFrameObject</span> <span class="o">=</span> <span class="n">new_ref_obj</span>

        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;base_link&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_object_list</span><span class="p">)):</span>
            <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_object_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_update_menu</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Removes marker from the world&#39;&#39;&#39;</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">erase</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">())</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">applyChanges</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_update_menu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Recreates the menu when something has changed&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span> <span class="o">=</span> <span class="n">MenuHandler</span><span class="p">()</span>
        <span class="n">frame_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;Reference frame&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
                            <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">parent</span><span class="o">=</span><span class="n">frame_entry</span><span class="p">,</span>
                            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">change_ref_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;Move arm here&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">move_to_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;Move to current arm pose&#39;</span><span class="p">,</span>
                            <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">move_pose_to_cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&#39;Delete&#39;</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_step_cb</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                            <span class="n">MenuHandler</span><span class="o">.</span><span class="n">UNCHECKED</span><span class="p">)</span>

        <span class="n">menu_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_menu_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_name</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">menu_id</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_object</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">menu_id</span><span class="p">,</span>
                            <span class="n">MenuHandler</span><span class="o">.</span><span class="n">CHECKED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_viz_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">())</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">applyChanges</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_menu_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the unique menu id from its name</span>
<span class="sd">        None if the object is not found&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">ref_name</span> <span class="ow">in</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">:</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ref_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_menu_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">menu_id</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the menu name from its unique menu id&#39;&#39;&#39;</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sub_entries</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">menu_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="p">[</span><span class="n">index</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_get_ref_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the name string for the reference</span>
<span class="sd">        frame object of the action step&#39;&#39;&#39;</span>

        <span class="n">ref_name</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span><span class="o">.</span><span class="n">refFrame</span>
                <span class="n">ref_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span><span class="o">.</span><span class="n">refFrameObject</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span><span class="o">.</span><span class="n">refFrame</span>
                <span class="n">ref_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span><span class="o">.</span><span class="n">refFrameObject</span><span class="o">.</span><span class="n">name</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rRefFrame</span>
                <span class="n">ref_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rRefFrameOject</span><span class="o">.</span><span class="n">name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ref_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lRefFrame</span>
                <span class="n">ref_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lRefFrameOject</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&#39;Unhandled marker type: &#39;</span> <span class="o">+</span>
                                        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ref_frame</span> <span class="o">==</span> <span class="n">ArmState</span><span class="o">.</span><span class="n">ROBOT_BASE</span><span class="p">):</span>
            <span class="n">ref_name</span> <span class="o">=</span> <span class="s">&#39;base_link&#39;</span>

        <span class="k">return</span> <span class="n">ref_name</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_set_ref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_ref_name</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Changes the reference frame of the action step&#39;&#39;&#39;</span>
        <span class="n">new_ref</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_ref_from_name</span><span class="p">(</span><span class="n">new_ref_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">new_ref</span> <span class="o">!=</span> <span class="n">ArmState</span><span class="o">.</span><span class="n">ROBOT_BASE</span><span class="p">):</span>
            <span class="n">index</span> <span class="o">=</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">new_ref_name</span><span class="p">)</span>
            <span class="n">new_ref_obj</span> <span class="o">=</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_ref_object_list</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_ref_obj</span> <span class="o">=</span> <span class="n">Object</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">convert_ref_frame</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span><span class="p">,</span> <span class="n">new_ref</span><span class="p">,</span> <span class="n">new_ref_obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">convert_ref_frame</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span><span class="p">,</span> <span class="n">new_ref</span><span class="p">,</span> <span class="n">new_ref_obj</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">timing</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">arm_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">arm_new</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">convert_ref_frame</span><span class="p">(</span><span class="n">arm_old</span><span class="p">,</span>
                                                      <span class="n">new_ref</span><span class="p">,</span> <span class="n">new_ref_obj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arm_new</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arm_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">arm_new</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">convert_ref_frame</span><span class="p">(</span><span class="n">arm_old</span><span class="p">,</span>
                                                      <span class="n">new_ref</span><span class="p">,</span> <span class="n">new_ref_obj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arm_new</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rRefFrameObject</span> <span class="o">=</span> <span class="n">new_ref_obj</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rRefFrame</span> <span class="o">=</span> <span class="n">new_ref</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lRefFrameObject</span> <span class="o">=</span> <span class="n">new_ref_obj</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lRefFrame</span> <span class="o">=</span> <span class="n">new_ref</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_is_hand_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Checks if the gripper is open for the action step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">gripper_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">gripperAction</span><span class="o">.</span><span class="n">rGripper</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gripper_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">gripperAction</span><span class="o">.</span><span class="n">lGripper</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">gripper_state</span> <span class="o">==</span> <span class="n">GripperState</span><span class="o">.</span><span class="n">OPEN</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">set_new_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_pose</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Changes the pose of the action step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">pose</span> <span class="o">=</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset_pose</span><span class="p">(</span><span class="n">new_pose</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span><span class="o">.</span><span class="n">ee_pose</span> <span class="o">=</span> <span class="n">pose</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pose</span> <span class="o">=</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset_pose</span><span class="p">(</span><span class="n">new_pose</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span><span class="o">.</span><span class="n">ee_pose</span> <span class="o">=</span> <span class="n">pose</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_viz</span><span class="p">()</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logwarn</span><span class="p">(</span><span class="s">&#39;Modification of whole trajectory &#39;</span> <span class="o">+</span>
                          <span class="s">&#39;segments is not implemented.&#39;</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_start</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the absolute position of the action step&#39;&#39;&#39;</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_absolute_pose</span><span class="p">(</span><span class="n">is_start</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pose</span><span class="o">.</span><span class="n">position</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_absolute_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_start</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the absolute pose of the action step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_start</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_start</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">arm_pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>if (arm_pose.refFrame == ArmState.OBJECT and
   World.has_object(arm_pose.refFrameObject.name)):
   return ActionStepMarker._offset_pose(arm_pose.ee_pose)
else:</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">world_pose</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_absolute_pose</span><span class="p">(</span><span class="n">arm_pose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset_pose</span><span class="p">(</span><span class="n">world_pose</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">get_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the pose of the action step&#39;&#39;&#39;</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">target</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset_pose</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">ee_pose</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_offset_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">,</span> <span class="n">constant</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Offsets the world pose for visualization&#39;&#39;&#39;</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_matrix_from_pose</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>
        <span class="n">offset_array</span> <span class="o">=</span> <span class="p">[</span><span class="n">constant</span> <span class="o">*</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">offset_transform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">translation_matrix</span><span class="p">(</span><span class="n">offset_array</span><span class="p">)</span>
        <span class="n">hand_transform</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">concatenate_matrices</span><span class="p">(</span><span class="n">transform</span><span class="p">,</span>
                                                        <span class="n">offset_transform</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">World</span><span class="o">.</span><span class="n">get_pose_from_transform</span><span class="p">(</span><span class="n">hand_transform</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Sets the new pose for the action step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span> <span class="o">=</span> <span class="n">target</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span> <span class="o">=</span> <span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">has_object</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_menu</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_edited</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj_index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns the pose for the action step&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">rArm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTarget</span><span class="o">.</span><span class="n">lArm</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">traj_index</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span>
                    <span class="n">traj_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="n">traj_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">traj_index</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span>
                    <span class="n">traj_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="n">traj_index</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_traj_pose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns a single pose for trajectory&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">arm_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">rArm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">lArm</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">target</span><span class="o">.</span><span class="n">ee_pose</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&#39;Cannot request trajectory pose &#39;</span> <span class="o">+</span>
                         <span class="s">&#39;on non-trajectory action step.&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_update_viz_core</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates visualization after a change&#39;&#39;&#39;</span>
        <span class="n">menu_control</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="p">()</span>
        <span class="n">menu_control</span><span class="o">.</span><span class="n">interaction_mode</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="o">.</span><span class="n">BUTTON</span>
        <span class="n">menu_control</span><span class="o">.</span><span class="n">always_visible</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">frame_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_name</span><span class="p">()</span>
        <span class="n">pose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pose</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TARGET</span><span class="p">):</span>
            <span class="n">menu_control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_gripper_marker</span><span class="p">(</span><span class="n">menu_control</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_is_hand_open</span><span class="p">())</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">ActionStep</span><span class="o">.</span><span class="n">ARM_TRAJECTORY</span><span class="p">):</span>
            <span class="n">point_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">timing</span><span class="p">)):</span>
                <span class="n">point_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_traj_pose</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">.</span><span class="n">position</span><span class="p">)</span>

            <span class="n">main_marker</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Marker</span><span class="o">.</span><span class="n">SPHERE_LIST</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">(),</span>
                                <span class="n">lifetime</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                <span class="n">scale</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">),</span>
                                <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="n">frame_id</span><span class="p">),</span>
                                <span class="n">color</span><span class="o">=</span><span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">),</span>
                                <span class="n">points</span><span class="o">=</span><span class="n">point_list</span><span class="p">)</span>
            <span class="n">menu_control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_marker</span><span class="p">)</span>
            <span class="n">menu_control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">make_sphere_marker</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">()</span> <span class="o">+</span> <span class="mi">2000</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_get_traj_pose</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">frame_id</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
            <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">armTrajectory</span><span class="o">.</span><span class="n">timing</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">menu_control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">make_sphere_marker</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">()</span> <span class="o">+</span> <span class="mi">3000</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_traj_pose</span><span class="p">(</span><span class="n">last_index</span><span class="p">),</span>
                <span class="n">frame_id</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">logerr</span><span class="p">(</span><span class="s">&#39;Non-handled action step type &#39;</span>
                         <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">action_step</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

        <span class="n">ref_frame</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_ref_from_name</span><span class="p">(</span><span class="n">frame_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ref_frame</span> <span class="o">==</span> <span class="n">ArmState</span><span class="o">.</span><span class="n">OBJECT</span><span class="p">):</span>
            <span class="n">menu_control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Marker</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Marker</span><span class="o">.</span><span class="n">ARROW</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">()),</span>
                        <span class="n">lifetime</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">),</span>
                        <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="n">frame_id</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">points</span><span class="o">=</span><span class="p">[</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="p">,</span> <span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]))</span>

        <span class="n">text_pos</span> <span class="o">=</span> <span class="n">Point</span><span class="p">()</span>
        <span class="n">text_pos</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span>
        <span class="n">text_pos</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span>
        <span class="n">text_pos</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="mf">0.1</span>
        <span class="n">menu_control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Marker</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Marker</span><span class="o">.</span><span class="n">TEXT_VIEW_FACING</span><span class="p">,</span>
                        <span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">(),</span> <span class="n">scale</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">),</span>
                        <span class="n">text</span><span class="o">=</span><span class="s">&#39;Step&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">step_number</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="n">frame_id</span><span class="p">),</span>
                        <span class="n">pose</span><span class="o">=</span><span class="n">Pose</span><span class="p">(</span><span class="n">text_pos</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>

        <span class="n">int_marker</span> <span class="o">=</span> <span class="n">InteractiveMarker</span><span class="p">()</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">()</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="n">frame_id</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">pose</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_6dof_marker</span><span class="p">(</span><span class="n">int_marker</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">menu_control</span><span class="p">)</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">int_marker</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">marker_feedback_cb</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">make_sphere_marker</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates a sphere marker&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">Marker</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">Marker</span><span class="o">.</span><span class="n">SPHERE</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">uid</span><span class="p">,</span> <span class="n">lifetime</span><span class="o">=</span><span class="n">rospy</span><span class="o">.</span><span class="n">Duration</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                        <span class="n">scale</span><span class="o">=</span><span class="n">Vector3</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="p">),</span>
                        <span class="n">pose</span><span class="o">=</span><span class="n">pose</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">Header</span><span class="p">(</span><span class="n">frame_id</span><span class="o">=</span><span class="n">frame_id</span><span class="p">),</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">marker_feedback_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Callback for when an event occurs on the marker&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">feedback</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">InteractiveMarkerFeedback</span><span class="o">.</span><span class="n">POSE_UPDATE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_new_pose</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">pose</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_viz</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">feedback</span><span class="o">.</span><span class="n">event_type</span> <span class="o">==</span> <span class="n">InteractiveMarkerFeedback</span><span class="o">.</span><span class="n">BUTTON_CLICK</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Set the visibility of the 6DOF controller</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">&#39;Changing visibility of the pose controls.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_marker_click_cb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_uid</span><span class="p">(),</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">&#39;Unknown event&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">event_type</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">delete_step_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Callback for when delete is requested&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_deleted</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">move_to_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Callback for when moving to a pose is requested&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_requested</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">move_pose_to_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dummy</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Callback for when a pose change to current is requested&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_edited</span> <span class="o">=</span> <span class="bp">True</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">pose_reached</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Update when a requested pose is reached&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_requested</span> <span class="o">=</span> <span class="bp">False</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">change_ref_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feedback</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Callback for when a reference frame change is requested&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_get_menu_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_ref_name</span><span class="p">()),</span>
                    <span class="n">MenuHandler</span><span class="o">.</span><span class="n">UNCHECKED</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">setCheckState</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">menu_entry_id</span><span class="p">,</span>
                    <span class="n">MenuHandler</span><span class="o">.</span><span class="n">CHECKED</span><span class="p">)</span>
        <span class="n">new_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_menu_name</span><span class="p">(</span><span class="n">feedback</span><span class="o">.</span><span class="n">menu_entry_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_ref</span><span class="p">(</span><span class="n">new_ref</span><span class="p">)</span>
        <span class="n">rospy</span><span class="o">.</span><span class="n">loginfo</span><span class="p">(</span><span class="s">&#39;Switching reference frame to &#39;</span>
                      <span class="o">+</span> <span class="n">new_ref</span> <span class="o">+</span> <span class="s">&#39; for action step &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_name</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">reApply</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="p">)</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">applyChanges</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_viz</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">update_viz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Updates visualization fully&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_viz_core</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_menu_handler</span><span class="o">.</span><span class="n">reApply</span><span class="p">(</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="p">)</span>
        <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_im_server</span><span class="o">.</span><span class="n">applyChanges</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_add_6dof_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_marker</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Adds a 6 DoF control marker to the interactive marker&#39;&#39;&#39;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;rotate_x&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">False</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;move_x&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;rotate_z&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">False</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;move_z&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;rotate_y&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">False</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span>
        <span class="n">control</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_6dof_control</span><span class="p">(</span><span class="s">&#39;move_y&#39;</span><span class="p">,</span>
                        <span class="n">Quaternion</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="bp">True</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">)</span>
        <span class="n">int_marker</span><span class="o">.</span><span class="n">controls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">control</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_make_6dof_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">orientation</span><span class="p">,</span> <span class="n">is_move</span><span class="p">,</span> <span class="n">is_fixed</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates one component of the 6dof controller&#39;&#39;&#39;</span>
        <span class="n">control</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="p">()</span>
        <span class="n">control</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">control</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">orientation</span>
        <span class="n">control</span><span class="o">.</span><span class="n">always_visible</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_control_visible</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">is_move</span><span class="p">:</span>
                <span class="n">control</span><span class="o">.</span><span class="n">interaction_mode</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="o">.</span><span class="n">MOVE_AXIS</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">control</span><span class="o">.</span><span class="n">interaction_mode</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="o">.</span><span class="n">ROTATE_AXIS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">control</span><span class="o">.</span><span class="n">interaction_mode</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="o">.</span><span class="n">NONE</span>
        <span class="k">if</span> <span class="n">is_fixed</span><span class="p">:</span>
            <span class="n">control</span><span class="o">.</span><span class="n">orientation_mode</span> <span class="o">=</span> <span class="n">InteractiveMarkerControl</span><span class="o">.</span><span class="n">FIXED</span>
        <span class="k">return</span> <span class="n">control</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_make_mesh_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Creates a mesh marker&#39;&#39;&#39;</span>
        <span class="n">mesh</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">()</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">mesh_use_embedded_materials</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">Marker</span><span class="o">.</span><span class="n">MESH_RESOURCE</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">mesh</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_reachable</span><span class="p">():</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mesh</span><span class="o">.</span><span class="n">color</span> <span class="o">=</span> <span class="n">ColorRGBA</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">mesh</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_make_gripper_marker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">is_hand_open</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Makes a gripper marker&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">is_hand_open</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">28</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">transform1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">euler_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
        <span class="n">transform1</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07691</span> <span class="o">-</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">transform2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">euler_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">transform2</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09137</span><span class="p">,</span> <span class="mf">0.00495</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">t_proximal</span> <span class="o">=</span> <span class="n">transform1</span>
        <span class="n">t_distal</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">concatenate_matrices</span><span class="p">(</span><span class="n">transform1</span><span class="p">,</span>
                                                           <span class="n">transform2</span><span class="p">)</span>

        <span class="n">mesh1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_mesh_marker</span><span class="p">()</span>
        <span class="n">mesh1</span><span class="o">.</span><span class="n">mesh_resource</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;package://pr2_description/meshes/&#39;</span> <span class="o">+</span>
                                <span class="s">&#39;gripper_v0/gripper_palm.dae&#39;</span><span class="p">)</span>
        <span class="n">mesh1</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset</span>
        <span class="n">mesh1</span><span class="o">.</span><span class="n">pose</span><span class="o">.</span><span class="n">orientation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">mesh2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_mesh_marker</span><span class="p">()</span>
        <span class="n">mesh2</span><span class="o">.</span><span class="n">mesh_resource</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;package://pr2_description/meshes/&#39;</span> <span class="o">+</span>
                               <span class="s">&#39;gripper_v0/l_finger.dae&#39;</span><span class="p">)</span>
        <span class="n">mesh2</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_pose_from_transform</span><span class="p">(</span><span class="n">t_proximal</span><span class="p">)</span>

        <span class="n">mesh3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_mesh_marker</span><span class="p">()</span>
        <span class="n">mesh3</span><span class="o">.</span><span class="n">mesh_resource</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;package://pr2_description/meshes/&#39;</span> <span class="o">+</span>
                               <span class="s">&#39;gripper_v0/l_finger_tip.dae&#39;</span><span class="p">)</span>
        <span class="n">mesh3</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_pose_from_transform</span><span class="p">(</span><span class="n">t_distal</span><span class="p">)</span>

        <span class="n">quat</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">quaternion_multiply</span><span class="p">(</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">quaternion_from_euler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">angle</span><span class="p">))</span>
        <span class="n">transform1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">quaternion_matrix</span><span class="p">(</span><span class="n">quat</span><span class="p">)</span>
        <span class="n">transform1</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.07691</span> <span class="o">-</span> <span class="n">ActionStepMarker</span><span class="o">.</span><span class="n">_offset</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">transform2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">euler_matrix</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">angle</span><span class="p">)</span>
        <span class="n">transform2</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.09137</span><span class="p">,</span> <span class="mf">0.00495</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">t_proximal</span> <span class="o">=</span> <span class="n">transform1</span>
        <span class="n">t_distal</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transformations</span><span class="o">.</span><span class="n">concatenate_matrices</span><span class="p">(</span><span class="n">transform1</span><span class="p">,</span>
                                                           <span class="n">transform2</span><span class="p">)</span>

        <span class="n">mesh4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_mesh_marker</span><span class="p">()</span>
        <span class="n">mesh4</span><span class="o">.</span><span class="n">mesh_resource</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;package://pr2_description/meshes/&#39;</span> <span class="o">+</span>
                               <span class="s">&#39;gripper_v0/l_finger.dae&#39;</span><span class="p">)</span>
        <span class="n">mesh4</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_pose_from_transform</span><span class="p">(</span><span class="n">t_proximal</span><span class="p">)</span>
        <span class="n">mesh5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_mesh_marker</span><span class="p">()</span>
        <span class="n">mesh5</span><span class="o">.</span><span class="n">mesh_resource</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;package://pr2_description/meshes/&#39;</span> <span class="o">+</span>
                               <span class="s">&#39;gripper_v0/l_finger_tip.dae&#39;</span><span class="p">)</span>
        <span class="n">mesh5</span><span class="o">.</span><span class="n">pose</span> <span class="o">=</span> <span class="n">World</span><span class="o">.</span><span class="n">get_pose_from_transform</span><span class="p">(</span><span class="n">t_distal</span><span class="p">)</span>

        <span class="n">control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh1</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh2</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh3</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh4</span><span class="p">)</span>
        <span class="n">control</span><span class="o">.</span><span class="n">markers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mesh5</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">control</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
